<!DOCTYPE html>
<!-- This Source Code Form is subject to the terms of the Mozilla Public
   - License, v. 2.0. If a copy of the MPL was not distributed with this file,
   - You can obtain one at http://mozilla.org/MPL/2.0/.  -->
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Welcome to MoTown</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <link href="/bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css" >
    <link href="/stylesheets/sidebar.css"   rel="stylesheet" type="text/css" media="screen">
    <script src="http://code.jquery.com/jquery-1.7.1.min.js" type="text/javascript"></script>
    <script src="/bootstrap/js/bootstrap.min.js" type="text/javascript"></script>
    <script src="https://browserid.org/include.js" type="text/javascript"></script>
    <script src="/javascripts/application.js" type="text/javascript"></script>  
    <script src="/javascripts/md5.js" type="text/javascript"></script>
    <!--script src="/javascripts/feed.js" type="text/javascript"></script-->
    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le fav and touch icons
    <link rel="shortcut icon" href="../assets/ico/favicon.ico">
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="../assets/ico/apple-touch-icon-57-precomposed.png"> -->
    <script type="text/javascript">
      var storyTemplate = null;
      var contactTemplate = null;
      var port = navigator.mozSocial.getWorker().port;

      var handlers = {
        'feed.story': function(data){
          dump(data + "\n\n");
          var li = storyTemplate.clone();
          li.attr('id', data.id);
          dump(data.id + "\n");
          if (data['media:thumbnail']){
            li.find('img.thumbnail').attr('src', data['media:thumbnail'].url);
          }
          else{
            li.find('img.thumbnail').remove();
          }
          li.find('p').text(data.description);
          li.click(function(){
            window.open(data.href, "motown_sidebar");
          });
          $('.feed ul').prepend(li);
          li.show();
        },
        'contacts.list': function(data){
          for (var i in data){
            var li = contactTemplate.clone();
            var contact = data[i];
            li.find('a').text(contact.realName).attr('href', 'https://mozillians.org/en-US/search?q=' + contact.nick);
            li.find('img').attr('src', contact.gravatar + "?s=30");

            if (contact.status != 'available'){
              li.find('svg').remove();
              li.find('.status').text(contact.status);
            }
            $('.contacts ul').append(li);
            li.show();

            dump("Contact:\n\t" + JSON.stringify(contact) + "\n");
          }

        }
      };

      port.onmessage = function(e) {

        var data = e.data;
        var handler = handlers[data.topic];
        
        if (handler){
          handler(data.data);
        }
        else{
          dump("Unhandled message: " + e.topic + "\n");
        }
      };

      $(function(){
        dump('Initializing Story UI\n');
        storyTemplate = $('#story_template');
        storyTemplate.removeAttr('id');
        $('.feed ul').empty();

        contactTemplate = $('#contact_template');
        contactTemplate.removeAttr('id');
        $('.contacts ul').empty();        

        $('#top_bar a').click(function(){
          window.open(this.href, 'settings');
          return false;
        });

        port.postMessage({topic: 'sidebar.registration'});
        dump("Sidebar initialized.\n");
      });

    </script>
  </head>

  <body>
    <div id="top_bar" class="fixed-top-bar">
      <h1>MoTown</h1>
      <ul><li><a href="/settings">Settings</a></li></ul>
    </div>
    <div class="feed">
      <ul>
        <li class="story" id="story_template">
          <img 
            class="thumbnail" 
            alt="placeholder alt" 
            height="30" 
            width="30" 
            src="https://secure.gravatar.com/avatar/ffcab65cd081527c38e6584ae729b276?s=30&d=https://a248.e.akamai.net/assets.github.com%2Fimages%2Fgravatars%2Fgravatar-140.png" />
          <p>bronson commented on issue 531 on twitter/bootstrap</p>
        </li>
      </ul>
    </div>
    <div class="contacts">
      <h2>Online Contacts</h2>
      <ul>
        <li id="contact_template">
          <img
            class="thumbnail"
            alt="Gravatar"
            height="30"
            width="30"
            src="http://www.gravatar.com/avatar/26beabd6213224f03555a80d5ef59d61?s=29" />
          <a href="https://mozillians.org/en-US/search?q=wex">Simon Wex</a>
          <span class="status">
            <svg xmlns="http://www.w3.org/2000/svg" version="1.1">
              <circle cx="15" cy="15" r="5" stroke="black" stroke-width="0" fill="green" />
            </svg>
          </span>
        </li>
      </ul>
    </div>
  </body>
</html>
